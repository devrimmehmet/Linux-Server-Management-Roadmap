# âš¡ Sunucu Ortam Kurulumu

Script dosyasÄ±nÄ± oluÅŸtur:

```bash
nano setup.sh
```

```bash
#!/bin/bash
set -e

# ==========================================================
# ğŸš€ Kubernetes Cluster Setup Script - Ubuntu 22.04.5 LTS
# ==========================================================

if [ "$EUID" -ne 0 ]; then
  echo "âŒ LÃ¼tfen root olarak Ã§alÄ±ÅŸtÄ±rÄ±n (sudo su -)."
  exit 1
fi

echo "ğŸš€ Kubernetes Cluster kurulumu baÅŸlÄ±yor..."

# 1. Sistem gÃ¼ncelleme
apt update && apt upgrade -y

# 2. Swap kapatma (Kubernetes iÃ§in ÅŸart)
swapoff -a
sed -i '/ swap / s/^/#/' /etc/fstab

# 3. Kernel modÃ¼lleri yÃ¼kleme
cat <<EOF | tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

modprobe overlay
modprobe br_netfilter

# 4. AÄŸ ayarlarÄ±
cat <<EOF | tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

sysctl --system

# 5. Containerd kurulumu
apt install -y apt-transport-https ca-certificates curl gnupg lsb-release

# Docker resmi repo ekle (daha gÃ¼ncel containerd iÃ§in)
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

apt update
apt install -y containerd.io

mkdir -p /etc/containerd
containerd config default | tee /etc/containerd/config.toml

# 5.1 systemd cgroup aktif et
sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
systemctl restart containerd
systemctl enable containerd

# 6. Kubernetes repo ekleme
mkdir -p /etc/apt/keyrings
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-archive-keyring.gpg
echo "deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /" | tee /etc/apt/sources.list.d/kubernetes.list

# 7. kubelet, kubeadm, kubectl kurulumu
apt update
apt install -y kubelet kubeadm kubectl
apt-mark hold kubelet kubeadm kubectl

# 8. Cluster baÅŸlatma (Calico ile uyumlu CIDR)
kubeadm init --pod-network-cidr=192.168.0.0/16

# 9. kubeconfig kullanÄ±cÄ±ya kopyala (root dÄ±ÅŸÄ±ndaki kullanÄ±cÄ±ya)
if [ -n "$SUDO_USER" ]; then
  USER_HOME=$(eval echo ~"$SUDO_USER")
  mkdir -p $USER_HOME/.kube
  cp -i /etc/kubernetes/admin.conf $USER_HOME/.kube/config
  chown $(id -u $SUDO_USER):$(id -g $SUDO_USER) $USER_HOME/.kube/config
else
  # EÄŸer root ile Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yorsa
  mkdir -p $HOME/.kube
  cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  chown $(id -u):$(id -g) $HOME/.kube/config
fi



# 10. Calico CNI kurulumu
export KUBECONFIG=/etc/kubernetes/admin.conf
kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/calico.yaml



# 11. Nginx Ingress Controller kurulumu
export KUBECONFIG=/etc/kubernetes/admin.conf
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml

# 12. Kubernetes Dashboard kurulumu
export KUBECONFIG=/etc/kubernetes/admin.conf
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml

# 12.1 Dashboard admin-user ekleme
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kubernetes-dashboard
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kubernetes-dashboard
EOF

# 13. Helm kurulumu
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# 14. Kurulum SonrasÄ± Kontroller
echo "âœ… Kubernetes kurulumu tamamlandÄ±!"
echo "â„¹ï¸ YÃ¶netim dosyasÄ±: ~/.kube/config"
echo "â„¹ï¸ Node durumu iÃ§in: kubectl get nodes"
echo "â„¹ï¸ Pod durumu iÃ§in: kubectl get pods -A"
echo "â„¹ï¸ Dashboard token almak iÃ§in: kubectl -n kubernetes-dashboard create token admin-user"
echo "â„¹ï¸ Ingress Controller ile domain yÃ¶nlendirmesi hazÄ±r."

```

â†’ Ä°Ã§ine yukarÄ±daki kodu yapÄ±ÅŸtÄ±r â†’ kaydet (CTRL+O, Enter, CTRL+X).

Ã‡alÄ±ÅŸtÄ±rÄ±labilir yap:

```bash
chmod +x setup.sh
```

Ã‡alÄ±ÅŸtÄ±r:

```bash
./setup.sh | tee setup.log
```

ğŸ‘‰ tee setup.log â†’ loglarÄ± dosyaya da yazacak, hata olursa inceleyebilirsin.

Kurulum bitince cluster hazÄ±r olacak.

âœ… Kurulum SonrasÄ± Kontroller

Cluster Ã§alÄ±ÅŸÄ±yor mu?

```bash
kubectl get nodes
```

Ready gÃ¶rmelisin.

Podlar ayaÄŸa kalktÄ± mÄ±?

```bash
kubectl get pods -A
```

Dashboard token al:

```bash
kubectl -n kubernetes-dashboard create token admin-user
```

Cluster saÄŸlÄ±ÄŸÄ±nÄ± test et

```bash
kubectl get nodes -o wide
kubectl get pods -A
```

Ä°stersen ilk test podunu daÄŸÄ±tabilirsin:

```bash
kubectl create deployment nginx --image=nginx
kubectl expose deployment nginx --port=80 --type=NodePort
kubectl get svc
```

1. Master Nodeâ€™a Pod Schedule Etmeyi AÃ§

```bash
kubectl taint nodes --all node-role.kubernetes.io/control-plane-
```

Bu komut ile control-plane nodeâ€™una da podâ€™lar schedule edilebilir. (kÃ¼Ã§Ã¼k cluster iÃ§in ÅŸart)

2. Pending PodlarÄ± Kontrol Et

```bash
kubectl get pods -A
```

2. Sunucudan dashboard aÃ§

```bash
 kubectl proxy
```

1. SSH TÃ¼nelleme (En gÃ¼venli yol)

Kendi bilgisayarÄ±ndan ÅŸunu aÃ§:
ssh -L 8001:localhost:8001 -p 2293 devrimmehmet@159.146.105.13

```bash
http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#/login
```

Running olacaklarÄ±nÄ± gÃ¶receksin.

kubernet-dashboard gelincede

token almak iÃ§in

```bash
 kubectl -n kubernetes-dashboard create token admin-user
```

ğŸ‘‰ Ã‡Ä±kan token ile dashboardâ€™a giriÅŸ yapabilirsin.
