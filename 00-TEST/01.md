# ⚡ Sunucu Ortam Kurulumu

Script dosyasını oluştur:

```bash
nano setup.sh
```

```bash
#!/bin/bash
set -e

# ==========================================================
# 🚀 Kubernetes Cluster Setup Script - Ubuntu 22.04.5 LTS
# ==========================================================

if [ "$EUID" -ne 0 ]; then
  echo "❌ Lütfen root olarak çalıştırın (sudo su -)."
  exit 1
fi

echo "🚀 Kubernetes Cluster kurulumu başlıyor..."

# 1. Sistem güncelleme
apt update && apt upgrade -y

# 2. Swap kapatma (Kubernetes için şart)
swapoff -a
sed -i '/ swap / s/^/#/' /etc/fstab

# 3. Kernel modülleri yükleme
cat <<EOF | tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

modprobe overlay
modprobe br_netfilter

# 4. Ağ ayarları
cat <<EOF | tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

sysctl --system

# 5. Containerd kurulumu
apt install -y apt-transport-https ca-certificates curl gnupg lsb-release

# Docker resmi repo ekle (daha güncel containerd için)
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

apt update
apt install -y containerd.io

mkdir -p /etc/containerd
containerd config default | tee /etc/containerd/config.toml

# 5.1 systemd cgroup aktif et
sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
systemctl restart containerd
systemctl enable containerd

# 6. Kubernetes repo ekleme
mkdir -p /etc/apt/keyrings
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-archive-keyring.gpg
echo "deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /" | tee /etc/apt/sources.list.d/kubernetes.list

# 7. kubelet, kubeadm, kubectl kurulumu
apt update
apt install -y kubelet kubeadm kubectl
apt-mark hold kubelet kubeadm kubectl

# 8. Cluster başlatma (Calico ile uyumlu CIDR)
kubeadm init --pod-network-cidr=192.168.0.0/16

# 9. kubeconfig kullanıcıya kopyala (root dışındaki kullanıcıya)
if [ -n "$SUDO_USER" ]; then
  USER_HOME=$(eval echo ~"$SUDO_USER")
  mkdir -p $USER_HOME/.kube
  cp -i /etc/kubernetes/admin.conf $USER_HOME/.kube/config
  chown $(id -u $SUDO_USER):$(id -g $SUDO_USER) $USER_HOME/.kube/config
else
  # Eğer root ile çalıştırılıyorsa
  mkdir -p $HOME/.kube
  cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  chown $(id -u):$(id -g) $HOME/.kube/config
fi



# 10. Calico CNI kurulumu
export KUBECONFIG=/etc/kubernetes/admin.conf
kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/calico.yaml



# 11. Nginx Ingress Controller kurulumu
export KUBECONFIG=/etc/kubernetes/admin.conf
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml

# 12. Kubernetes Dashboard kurulumu
export KUBECONFIG=/etc/kubernetes/admin.conf
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml

# 12.1 Dashboard admin-user ekleme
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kubernetes-dashboard
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kubernetes-dashboard
EOF

# 13. Helm kurulumu
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# 14. Kurulum Sonrası Kontroller
echo "✅ Kubernetes kurulumu tamamlandı!"
echo "ℹ️ Yönetim dosyası: ~/.kube/config"
echo "ℹ️ Node durumu için: kubectl get nodes"
echo "ℹ️ Pod durumu için: kubectl get pods -A"
echo "ℹ️ Dashboard token almak için: kubectl -n kubernetes-dashboard create token admin-user"
echo "ℹ️ Ingress Controller ile domain yönlendirmesi hazır."

```

→ İçine yukarıdaki kodu yapıştır → kaydet (CTRL+O, Enter, CTRL+X).

Çalıştırılabilir yap:

```bash
chmod +x setup.sh
```

Çalıştır:

```bash
./setup.sh | tee setup.log
```

👉 tee setup.log → logları dosyaya da yazacak, hata olursa inceleyebilirsin.

Kurulum bitince cluster hazır olacak.

✅ Kurulum Sonrası Kontroller

Cluster çalışıyor mu?

```bash
kubectl get nodes
```

Ready görmelisin.

Podlar ayağa kalktı mı?

```bash
kubectl get pods -A
```

Dashboard token al:

```bash
kubectl -n kubernetes-dashboard create token admin-user
```

Cluster sağlığını test et

```bash
kubectl get nodes -o wide
kubectl get pods -A
```

İstersen ilk test podunu dağıtabilirsin:

```bash
kubectl create deployment nginx --image=nginx
kubectl expose deployment nginx --port=80 --type=NodePort
kubectl get svc
```

1. Master Node’a Pod Schedule Etmeyi Aç

```bash
kubectl taint nodes --all node-role.kubernetes.io/control-plane-
```

Bu komut ile control-plane node’una da pod’lar schedule edilebilir. (küçük cluster için şart)

2. Pending Podları Kontrol Et

```bash
kubectl get pods -A
```

2. Sunucudan dashboard aç

```bash
 kubectl proxy
```

1. SSH Tünelleme (En güvenli yol)

Kendi bilgisayarından şunu aç:
ssh -L 8001:localhost:8001 -p 2293 devrimmehmet@159.146.105.13

```bash
http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#/login
```

Running olacaklarını göreceksin.

kubernet-dashboard gelincede

token almak için

```bash
 kubectl -n kubernetes-dashboard create token admin-user
```

👉 Çıkan token ile dashboard’a giriş yapabilirsin.
