#!/bin/bash
set -e

# ==========================================================

# 🧹 Kubernetes Cluster Cleanup Script - Ubuntu 22.04.5 LTS

# ==========================================================

if [ "$EUID" -ne 0 ]; then
echo "❌ Lütfen root olarak çalıştırın (sudo su -)."
exit 1
fi

echo "🧹 Mevcut Kubernetes cluster ve ayarları temizleniyor..."

# 1. kubeadm reset

echo "👉 kubeadm reset çalıştırılıyor..."
kubeadm reset -f

# 2. Servisleri durdur

echo "👉 kubelet ve containerd durduruluyor..."
systemctl stop kubelet || true
systemctl stop containerd || true

# 3. Kubernetes configlerini sil

echo "👉 Kubernetes config dosyaları siliniyor..."
rm -rf /etc/cni/net.d
rm -rf /etc/kubernetes
rm -rf /var/lib/etcd
rm -rf /var/lib/kubelet/\*
rm -rf /var/lib/dockershim
rm -rf /var/run/kubernetes

# 4. Containerd ayarlarını sıfırla

echo "👉 Containerd config temizleniyor..."
rm -f /etc/containerd/config.toml
systemctl restart containerd

# 5. Kullanıcı kubeconfig temizle

echo "👉 Kullanıcı kubeconfig temizleniyor..."
rm -rf $HOME/.kube

# 6. Ağ eklentisi kalıntılarını temizle

echo "👉 Ağ eklentisi (CNI) kalıntıları temizleniyor..."
rm -rf /etc/cni
rm -rf /opt/cni

# 7. iptables kurallarını temizle

echo "👉 iptables kuralları temizleniyor..."
iptables -F
iptables -t nat -F
iptables -t mangle -F
iptables -X
ipvsadm --clear 2>/dev/null || true

# 8. Servisleri tekrar başlat

echo "👉 containerd ve kubelet yeniden başlatılıyor..."
systemctl restart containerd || true
systemctl restart kubelet || true

# 9. SSH ayarlarını düzelt

echo "👉 SSH port ayarlanıyor (22 kapalı, 2293 açık)..."

# sshd_config içinde Port satırı yoksa ekle, varsa değiştir

if grep -q "^Port" /etc/ssh/sshd_config; then
sed -i 's/^Port .\*/Port 2293/' /etc/ssh/sshd_config
else
echo "Port 2293" >> /etc/ssh/sshd_config
fi

# ufw varsa etkileşimsiz uygula

if command -v ufw >/dev/null 2>&1; then
yes | ufw delete allow 22/tcp >/dev/null 2>&1 || true
ufw allow 2293/tcp
fi

# firewall-cmd varsa uygula

if command -v firewall-cmd >/dev/null 2>&1; then
firewall-cmd --permanent --remove-port=22/tcp || true
firewall-cmd --permanent --add-port=2293/tcp
firewall-cmd --reload
fi

# ssh servisini yeniden başlat

systemctl restart sshd

# sshd_config içinde 2293 portunu ayarla

if ! grep -q "^Port 2293" /etc/ssh/sshd_config; then
sed -i 's/^#\?Port .\*/Port 2293/' /etc/ssh/sshd_config
fi

# ufw varsa kural ekle

if command -v ufw >/dev/null 2>&1; then
ufw delete allow 22/tcp >/dev/null 2>&1 || true
ufw allow 2293/tcp
fi

# firewall-cmd varsa ekle (RHEL tabanlı ama tedbiren)

if command -v firewall-cmd >/dev/null 2>&1; then
firewall-cmd --permanent --remove-port=22/tcp || true
firewall-cmd --permanent --add-port=2293/tcp
firewall-cmd --reload
fi

# ssh servisini yeniden başlat

systemctl restart sshd

echo "✅ Kubernetes ortamı tamamen temizlendi!"
echo "✅ SSH ayarlandı -> Port 2293 aktif, 22 kapalı"
echo "ℹ️ Yeniden kurulum için setup.sh çalıştırabilirsiniz."
