#!/bin/bash
set -e

# ==========================================================

# ğŸ§¹ Kubernetes Cluster Cleanup Script - Ubuntu 22.04.5 LTS

# ==========================================================

if [ "$EUID" -ne 0 ]; then
echo "âŒ LÃ¼tfen root olarak Ã§alÄ±ÅŸtÄ±rÄ±n (sudo su -)."
exit 1
fi

echo "ğŸ§¹ Mevcut Kubernetes cluster ve ayarlarÄ± temizleniyor..."

# 1. kubeadm reset

echo "ğŸ‘‰ kubeadm reset Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
kubeadm reset -f

# 2. Servisleri durdur

echo "ğŸ‘‰ kubelet ve containerd durduruluyor..."
systemctl stop kubelet || true
systemctl stop containerd || true

# 3. Kubernetes configlerini sil

echo "ğŸ‘‰ Kubernetes config dosyalarÄ± siliniyor..."
rm -rf /etc/cni/net.d
rm -rf /etc/kubernetes
rm -rf /var/lib/etcd
rm -rf /var/lib/kubelet/\*
rm -rf /var/lib/dockershim
rm -rf /var/run/kubernetes

# 4. Containerd ayarlarÄ±nÄ± sÄ±fÄ±rla

echo "ğŸ‘‰ Containerd config temizleniyor..."
rm -f /etc/containerd/config.toml
systemctl restart containerd

# 5. KullanÄ±cÄ± kubeconfig temizle

echo "ğŸ‘‰ KullanÄ±cÄ± kubeconfig temizleniyor..."
rm -rf $HOME/.kube

# 6. AÄŸ eklentisi kalÄ±ntÄ±larÄ±nÄ± temizle

echo "ğŸ‘‰ AÄŸ eklentisi (CNI) kalÄ±ntÄ±larÄ± temizleniyor..."
rm -rf /etc/cni
rm -rf /opt/cni

# 7. iptables kurallarÄ±nÄ± temizle

echo "ğŸ‘‰ iptables kurallarÄ± temizleniyor..."
iptables -F
iptables -t nat -F
iptables -t mangle -F
iptables -X
ipvsadm --clear 2>/dev/null || true

# 8. Servisleri tekrar baÅŸlat

echo "ğŸ‘‰ containerd ve kubelet yeniden baÅŸlatÄ±lÄ±yor..."
systemctl restart containerd || true
systemctl restart kubelet || true

# 9. SSH ayarlarÄ±nÄ± dÃ¼zelt

echo "ğŸ‘‰ SSH port ayarlanÄ±yor (22 kapalÄ±, 2293 aÃ§Ä±k)..."

# sshd_config iÃ§inde Port satÄ±rÄ± yoksa ekle, varsa deÄŸiÅŸtir

if grep -q "^Port" /etc/ssh/sshd_config; then
sed -i 's/^Port .\*/Port 2293/' /etc/ssh/sshd_config
else
echo "Port 2293" >> /etc/ssh/sshd_config
fi

# ufw varsa etkileÅŸimsiz uygula

if command -v ufw >/dev/null 2>&1; then
yes | ufw delete allow 22/tcp >/dev/null 2>&1 || true
ufw allow 2293/tcp
fi

# firewall-cmd varsa uygula

if command -v firewall-cmd >/dev/null 2>&1; then
firewall-cmd --permanent --remove-port=22/tcp || true
firewall-cmd --permanent --add-port=2293/tcp
firewall-cmd --reload
fi

# ssh servisini yeniden baÅŸlat

systemctl restart sshd

# sshd_config iÃ§inde 2293 portunu ayarla

if ! grep -q "^Port 2293" /etc/ssh/sshd_config; then
sed -i 's/^#\?Port .\*/Port 2293/' /etc/ssh/sshd_config
fi

# ufw varsa kural ekle

if command -v ufw >/dev/null 2>&1; then
ufw delete allow 22/tcp >/dev/null 2>&1 || true
ufw allow 2293/tcp
fi

# firewall-cmd varsa ekle (RHEL tabanlÄ± ama tedbiren)

if command -v firewall-cmd >/dev/null 2>&1; then
firewall-cmd --permanent --remove-port=22/tcp || true
firewall-cmd --permanent --add-port=2293/tcp
firewall-cmd --reload
fi

# ssh servisini yeniden baÅŸlat

systemctl restart sshd

echo "âœ… Kubernetes ortamÄ± tamamen temizlendi!"
echo "âœ… SSH ayarlandÄ± -> Port 2293 aktif, 22 kapalÄ±"
echo "â„¹ï¸ Yeniden kurulum iÃ§in setup.sh Ã§alÄ±ÅŸtÄ±rabilirsiniz."
